<!DOCTYPE html>
<html>
	<head>
		<title>Lollipop Lollapalooza</title>
		<script src="https://cdn.firebase.com/js/client/2.3.1/firebase.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
		<link rel="stylesheet" href="bootstrap.min.css">
		<script type="text/javascript">

			var db = new Firebase("https://popping-torch-5004.firebaseio.com/");

			function add(){
				var name = $('#name');
				xmlhttp = new XMLHttpRequest();
				xmlhttp.open('GET', 'https://crossorigin.me/http://naitian.mooo.com:8080?uname=' + name.val());
				xmlhttp.onload = function (e) {
				  	if (xmlhttp.readyState === 4) {
				    	if (xmlhttp.status === 200) {
				    		var response = JSON.parse(xmlhttp.responseText);
				    		if(response.count < 1){
				    			alert("Error: No user found.")
				    		}
				    		else{
				    			var score = $('#score');
								
								var	full_name = response.results[0].full_name;
								var id = response.results[0].id;
				    			var checked = $('input[type=\'radio\']:checked');

								var entry = {
									score: parseInt(score.val()),
									name: full_name,
									course: checked.val()
								}

								console.log(entry.name);
								userRef = db.child(id);
								
								userRef.once("value", function(data){
									if(data.exists()){
										console.log(data.val());
										console.log(data.val().score);	
										if(data.val().score < entry.score){
											console.log("started the thing")
											userRef.setPriority(-1 * entry.score);
											console.log("setPriority");
											userRef.update({
												"score":entry.score,
												"course":entry.course
											}, function(error){
												if(error){
													console.log("bad");
													message("bad", "Score Upload Failed", "Darn... something went wrong...");
												}
												else {
													console.log("good");
													message("good", "Nice!", "The thing worked");
												}
											});
										}
									}
									else{
										userRef.setWithPriority({course: entry.course, name: entry.name, score: entry.score}, -1 * entry.score);
										//alert("does not exist");
									}
								}, function(error){
									alert("error");
								})
								score.prop("value", "");
								name.prop("value", "");
								checked.prop("checked", false);

				    		}
				    	}
				  	}
				}
				xmlhttp.send(null);
				
			}

			function message(type, title, message){
				switch(type){
					case "good": 
						$("#message").prop("class", "alert alert-dismissible alert-success");
						break;
					case "bad": 
						$("#message").prop("class", "alert alert-dismissible alert-danger");
						break;
					default: 
						$("#message").prop("class", "alert alert-dismissible alert-info");
						break;
				}

				$("#strong").text(title);
				$("#body-text").text(message);
				$("#message").prop("title", title + ": " + message);

				$("#message").show();

			}

			function display(snapshot){
				var i = 1;
				$("#tbody").empty();
				$("#class-compare").empty();
				var scoreArray = [0, 0, 0];
				var classArray = ["APCS", "Mobile", "Teacher"];
				snapshot.forEach(function(childSnapshot){
					$('#tbody').append("<tr><td>" + i + "</td><td>" + childSnapshot.val().score + "</td><td>" + childSnapshot.val().name + "</td><td>" + childSnapshot.val().course + "</td></tr>");
					i++;
					switch(childSnapshot.val().course){
						case "APCS":
							scoreArray[0] += childSnapshot.val().score;
							break;
						case "Mobile":
							scoreArray[1] += childSnapshot.val().score;
							break;
						case "Teacher":
							scoreArray[2] += childSnapshot.val().score;
							break;
					}
				})

				var i = scoreArray.indexOf(Math.max.apply(Math, scoreArray));
				var sortedNames = [];
				var sortedScores = [];
				sortedNames[0] = classArray[i];
				sortedScores[0] = scoreArray[i];
				scoreArray[i] = -1;
				i = scoreArray.indexOf(Math.max.apply(Math, scoreArray));
				sortedNames[1] = classArray[i];
				sortedScores[1] = scoreArray[i];
				scoreArray[i] = -1;
				i = scoreArray.indexOf(Math.max.apply(Math, scoreArray));
				sortedNames[2] = classArray[i];
				sortedScores[2] = scoreArray[i];


				for(var i = 1; i <= 3; i++){
					$("#class-compare").append("<tr><td>" + i + "</td><td>" + sortedScores[i - 1] + "</td><td>" + sortedNames[i-1] + "</td></tr>");
				}

			}

			db.orderByPriority().on("value", function(snapshot){
				display(snapshot);
			}, function(error){
				if(error)
					console.log("well crap" + error.code);

			})
		</script>
	</head>
	<body onload="$('#message').hide()">
		<h2 style="text-align:center">Lollipop <strike>Masters</strike> Lollapalooza</h2>
		<div id="container" class="container">
			<div class="row">
				<table class="table table-striped table-hover col-md-12">
					<thead>
						<tr>
							<th>#</th>
							<th>Score</th>
							<th>Name</th>
							<th>Class</th>
						</tr>
					</thead>
					<tbody id="tbody">
						
					</tbody>
				</table>
			</div>	
			<div class="row">
				<div id="form" class="col-md-6">
					<h5>Submit your score:</h5>
					<input id="score" type="number" min="0" placeholder="Score" class="top form-control" required> 
					<input id="name" type="text" placeholder="Ion Username" class="top form-control" required><br />

					<div id="radii" class="row">
						<div class="radio col-md-4" style="margin-top: 0px">
							<label>
								<input id="apcs" type="radio" name="c" value="APCS" required>
								APCS
							</label>
						</div>
						<div class="radio col-md-4" style="margin-top: 0px">
							<label>
								<input id="mob" type="radio" name="c" value="Mobile" required>
								Mobile
							</label>
						</div>
						<div class="radio col-md-4" style="margin-top: 0px">
							<label>
								<input id="teach" type="radio" name="c" value="Teacher" required>
								Teacher
							</label>
						</div>
					</div>
					<a onclick="add()" class="btn btn-primary" id="side">Submit</a>
				</div>
				<div id="compete" class="col-md-6">
					<h5>Class Comparison</h5>
					<table id="compete-table" class="table table-striped table-hover">	
						<thead>
							<tr>
								<th>#</th>
								<th>Score</th>
								<th>Class</th>
							</tr>
						</thead>
						<tbody id="class-compare">
							
						</tbody>
					</table>
				</div>
				
			</div>
		</div>
		<br />
		<a href="faq.html" id="faq">faq</a>
		<div id="message" class="alert alert-dismissible alert-success" title="">
		  	<button type="button" class="close" data-dismiss="alert" onclick="$('#message').hide()">x</button>
		  	<strong id="strong"></strong><div id="body-text"></div>
		</div>
	</body>
	
	<style>
		#faq{
			text-align: center;
		    margin: 0 auto;
		    width: 100%;
		    display: inline-block;
		}

		#message {
			position: fixed;
			bottom: 10px;
			right: 10px;
			overflow: hidden;
			width: 30%;
			text-overflow: ellipsis;
		}
		#container {
			padding-top: 50px;
			width: 50%;
		}

		#form #compete {
			margin-left: -15px;
			margin-right: -15px;
		}

		#side {
			width: 100%;
			display: inline-block;
		}
		#radii {
			margin: 0 auto;
			display: block;
			vertical-align: center;
		}

	</style>

</html>